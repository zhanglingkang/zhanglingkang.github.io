---
layout: post
title: "四层转发和七层转发区别"
subtitle: ""
date: 2020-05-22
author: "zlk"
catalog: true
tags:
  - NAT
  - NAPT
---

### 前言

负载均衡一般会涉及到以下几个概念

- 数据转发方式（四层转发和七层转发）
- 转发策略或者说流量调度策略，（轮询、加权轮询、最少链接、加权最少链接、hash 等）
- 故障转移（通过健康检查发现异常服务）

本文主要讲下四层转发和七层转发的差异

### 实现方式

以阿里的 SLB 为例

- 四层转发：通过 LVS 实现，LVS 直接将数据转发到后端的真正服务器
- 七层转发：通过 LVS 转发给 Tengine，然后再将数据转发到后端真正的服务器，因此七层转发理论上效率比四层低

### 支持协议

- 四层转发， TCP 或 UDP
- 七层转发，一般是 HTTP 或 HTTPS

### 链接建立方式

- 四层转发，LVS 通过 NAPT 方式，直接修改 TCP 数据包的 目的 IP 地址和目的端口号，相当于后端服务器直接跟客户端建立 TCP 链接
- 七层转发，因为负载均衡机器会解析应用层内容，相当于客户端跟负载均衡服务器建立 TCP 链接，负载均衡服务器再跟后端建立 TCP 链接

### 具体过程

- 四层转发 通过网络地址转换，调度器重写请求报文的目标地址，根据预设的调度算法，将请求分派给后端真实服务器；真实服务器的响应报文通过调度器时，报文源地址被重写再返回给客户，完成整个负载调度过程
- 七层转发 类似 nginx，不再细说
