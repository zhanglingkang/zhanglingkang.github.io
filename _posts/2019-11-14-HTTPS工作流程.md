---
layout: post
title: "HTTPS"
subtitle: "HTTPS的工作模式"
date: 2019-11-14
author: "zlk"
catalog: true
tags:
  - HTTPS
  - 网络协议
  - 加密
---

使用 HTTPS 通信主要是为了保证通信内容的安全，防止被中间层获取消息，所以通信内容要进行加密。

### 加密方式

- 对称加密 加密和解密使用相同的秘钥
- 非对称加密 加密和解密使用不同的秘钥

如果基于对称加密方式进行内容传输，黑客截获内容后没有秘钥，是无法破解内容的，但是有个问题，秘钥怎么传输？如果是一对一的，可以私下偷偷沟通好秘钥，但是一个网站一般都是面向众多用户的，如何传递秘钥？

如果使用非对称加密，用公钥加密的内容只能使用私钥解密，用私钥加密的内容只能使用公钥解密。

如果网站自己生成私钥、公钥，私钥自己保留，用户从网站拿到公钥，然后用公钥进行加密，黑客截获内容后，因为没有私钥，所以也无法破解传输内容。但是有个问题，网站发给用户的内容用私钥加密，用公钥解密，因为公钥是公开的，所以。。

如果用户自己也生成一对私钥、公钥，把自己的公钥给到网站，网站使用用户的公钥加密内容，黑客拿到内容后没有用户的私钥，无法破解内容。完美！

但是用户如何拿到网站的公钥呢？如果一开始黑客冒充网站，给用户自己生成的公钥，然后跟用户通信，然后自己又冒充用户，跟网站通信。。。

如何鉴别自己拿到的公钥是网站的公钥呢？毕竟每个人都可以创建自己的私钥和公钥

这个时候就需要权威部门的介入了，每个人都可以说自己是谁，所以需要公安机关给你的身份证来证明。网站需要数字证书来证明自己的身份。

### 数字证书

数字证书包含的内容（不只是以下内容）

- 证书持有者的公钥
- 证书的颁发机构
- 证书的有效期

用户怎么知道这个数字证书是可靠的呢？怎么知道这个身份证是不是个假证？生成证书需要一个权威机构认证，这个权威机构我们称为 CA（Certificate Authority）

如何确认证书是有效的呢？CA 会给证书进行一个签名，那怎么才能保证这个签名是 CA 的签名呢？很简单，需要只有掌握在 CA 手里的东西进行签名，这个就是 CA 的私钥

签名后的证书（不只是以下内容）

- Issuer，证书是谁颁发的
- Subject，就是证书颁发给谁
- Validity 是证书期限
- Public-key 是公钥内容
- Signature Algorithm 是签名算法

目前的现状是，用户从网站得到的不是公钥，而是 CA 签名的包含网站公钥的数字证书，我们用 CA 的公钥去解密数字证书的签名，如果可以解密成功，则说明网站的公钥没有问题，那么如何确定 CA 的公钥就是正确呢？好像陷入死循环了。。

为了确认 CA 的公钥是否正确，就需要用给 CA 签名的 CA 的公钥解密，这样层层下去，直到 root CA，全球皆知的几个著名大 CA

非对称加密在性能上是不如对称加密的，所以可以两者结合，非对称加密主要用于传递秘钥、对称加密用于数据通信。

### HTTPS 流程

![https](/img/https.jpg)

当浏览器访问一个网站的时候，网站会给浏览器一个服务端的证书，浏览器肯定不会直接相信这个证书，而是先对证书进行校验，判断颁发证书的 CA 是不是自己信任的 CA，如果不是，就继续判断 CA 的 CA 是不是自己信任的，不断追溯，直到确认 CA 可信或者不可信。（系统或浏览器有自己的根证书库）

### 根证书与中间证书的区别

根证书是自签名的，解密根证书的签名使用根证书自己公钥即可

解密中间证书的签名使用上一级证书的公钥。